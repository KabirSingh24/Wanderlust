<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: head('listings-detail')}">
    <title th:text="${selectedList.title}">List-Detail</title>
</head>
<body>
<div th:replace="~{fragments/header :: navbar}"></div>
<div class="container mt-3">
    <!-- ‚úÖ Success Message -->
    <div th:if="${success}" class="alert alert-success" role="alert">
        <i class="fa-solid fa-check-circle"></i> <span th:text="${success}"></span>
    </div>

    <!-- ‚ùå Failure Message -->
    <div th:if="${failure}" class="alert alert-danger" role="alert">
        <i class="fa-solid fa-xmark"></i> <span th:text="${failure}"></span>
    </div>

</div>

<div class="mt-3 offset-1">
    <a th:href="@{/listings/all}"><button class="btn btn-dark"><i class="fa-solid fa-backward"></i></button></a>
</div>
<main class="container my-2 ">
    <div class="row">
        <div class="col-8 offset-3"></div>
        <div class="col-6 listings-card offset-3 show-card">
            <div><h3 th:text="${selectedList.title}"></h3></div>
            <img th:src="${selectedList.images_url}" class="img-fluid rounded show-img" alt="Listing image"/>
            <div class="card-body mt-3">
                <h5><strong><p class="card-title" th:text="${selectedList.title}"></p></strong></h5>
                <p class="card-text">
                    <strong>Owner:</strong> <span th:if="${selectedList.user!=null}" th:text="${selectedList.user.name}"></span></br></br>
                    <strong>
                        Description:
                    </strong>
                    <span th:text="${selectedList.description}">
                    </span></br></br>
                <strong>Location:</strong> <span th:text="${selectedList.location}"></span></br></br>
                <strong>Price per Night:</strong> ‚Çπ <span th:text="${selectedList.price}"></span> / night</br></br>
                <strong>Country:</strong> <span th:text="${selectedList.country}"></span>
                    </p>
            </div>
        </div>
        <div class="col-1" th:if="${selectedList.user != null and session.LOGGED_USER_ID==selectedList.user.id}">
        <a th:href="@{/listings/{id}/edit(id=${selectedList.id})}"><button class="btn btn-primary">
                <i class="fa-regular fa-pen-to-square"></i>
            </button></a>
        </div>
        <div class="col-1" th:if="${selectedList.user != null and session.LOGGED_USER_ID==selectedList.user.id}">

        <form th:action="@{/listings/{id}/delete(id=${selectedList.id})}">
            <button type="submit" class="delete-btn">
                <i class="fa-solid fa-trash"></i>
            </button>
        </form></div>
        <div class="col-8 offset-3 mb-3 mt-4">
            <hr>
            <div th:if="${session.LOGGED_USER_ID != null and session.LOGGED_USER_ID!=selectedList.user.id}">
            <h4>Leave a Review</h4>
            <form th:action="@{/reviews/add/{listingId}(listingId=${selectedList.id})}"
                  th:object="${newReview}" method="post" novalidate class="needs-validation">
                <div class="mb-3 mt-3">
                <label for="reviews" class="form-label">Rating</label>
                    <fieldset class="starability-slot">
                        <legend>First rating:</legend>
                        <input type="radio" id="no-rate" class="input-no-rate" name="reviews" value="1" checked aria-label="No rating." />
                        <input type="radio" id="first-rate1" name="reviews" value="1" />
                        <label for="first-rate1" title="Terrible">1 star</label>
                        <input type="radio" id="first-rate2" name="reviews" value="2" />
                        <label for="first-rate2" title="Not good">2 stars</label>
                        <input type="radio" id="first-rate3" name="reviews" value="3" />
                        <label for="first-rate3" title="Average">3 stars</label>
                        <input type="radio" id="first-rate4" name="reviews" value="4" />
                        <label for="first-rate4" title="Very good">4 stars</label>
                        <input type="radio" id="first-rate5" name="reviews" value="5" />
                        <label for="first-rate5" title="Amazing">5 stars</label>
                    </fieldset>
                </div>
                <div class="mb-3 mt-3">
                <label for="comment" class="form-label">Comment</label>
                <textarea th:field="*{comment}" cols="30" rows="5" id="comment" class="form-control" required></textarea>
                    <div class="invalid-feedback">Please add some comments for review</div>
                </div>
                <button type="submit" class="btn btn-success">Submit Review</button>
            </form>
            </div>
            <hr>

            <p th:if="${selectedList.reviews!=null}"><b>ALL Reviews</b></p>
            <div class="row" >
                <div th:if="${#lists.isEmpty(selectedList.reviews)}" class="col-12">
                    <div class="card p-3 shadow-sm">
                        <h5 class="card-title">No reviews yet. Be the first to review!</h5>
                    </div>
                </div>

                <!-- üîπ Each Review = One Card -->
                <div th:each="review : ${selectedList.reviews}" th:if="${review != null}" class="col-md-6 mb-3">
                    <div class="card shadow-sm h-200">
                        <div class="card-body mb-3 ms-3 mt-3">
                            <h5 class="card-title" th:text="${review.user != null ? review.user.name : 'WanderlustUser'}"></h5>
                            <p class="starability-result card-text mb-1" th:attr="data-rating=${review.reviews}">
                            <strong>Rating:</strong>
                            <span th:text="${review.reviews}">5</span> ‚≠ê
                            </p>
                            <p class="card-text">
                                <strong>Comment:</strong>
                                <span th:text="${review.comment}">Nice place!</span>
                            </p>
                            <div th:if="${review.user!=null and session.LOGGED_USER_ID== review.user.id}">
                            <form th:action="@{/reviews/{listingId}/delete/{reviewId}(listingId=${selectedList.id},reviewId=${review.id})}" method="post"
                                  onsubmit="return confirm('Are you sure you want to delete this review?');">
                                <input type="hidden" name="_method" value="delete"/>
                                <button type="submit" class="btn btn-danger btn-sm">
                                    <i class="fa fa-trash"></i> Delete
                                </button>
                            </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <hr>
        </div>
        <div class="col-8 offset-3 mb-3">
            <h3>Where you'll be</h3>
            <div id="map"></div>
        </div>
    </div>
</main>
<div th:replace="~{fragments/footer :: footer}"></div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script th:src="@{/js/map.js}"></script>
<script th:src="@{/js/script.js}"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    const address = [[${selectedList.location}]] + ', ' + [[${selectedList.country}]];
    const title = [[${selectedList.title}]];
    /*]]>*/

    fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address)}&format=json`)
      .then(res => res.json())
      .then(data => {
        if (data && data.length > 0) {
          // ‚úÖ Convert to float
          const lat = parseFloat(data[0].lat);
          const lon = parseFloat(data[0].lon);

          const map = L.map('map').setView([lat, lon], 13);

          // üó∫Ô∏è Map layer
          L.tileLayer(`https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=rq4SvmsD98tIU0oLTLLC`, {
            tileSize: 512,
            zoomOffset: -1,
            attribution: '&copy; <a href="https://www.maptiler.com/">MapTiler</a>'
          }).addTo(map);

          // üü• Default red icon
          const redIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
          });

          // üß≠ Font Awesome compass for hover
          const compassIcon = L.divIcon({
            html: '<i class="fa-solid fa-compass fa-2x compass-icon"></i>',
            className: 'custom-fa-icon',
            iconSize: [30, 30],
            iconAnchor: [15, 30]
          });

          // üìç Marker
          const marker = L.marker([lat, lon], { icon: redIcon }).addTo(map)
            .bindPopup(`<b>${title}</b><br><p>Exact location provided after booking</p>`)
            .openPopup();

          // üî¥ Radar circle
          const radarCircle = L.circle([lat, lon], {
            color: 'red',
            fillColor: 'rgba(255,0,0,0.2)',
            fillOpacity: 0.3,
            radius: 300
          }).addTo(map);

          // üé® Hover effect
          marker.on('mouseover', () => marker.setIcon(compassIcon));
          marker.on('mouseout', () => marker.setIcon(redIcon));

          setTimeout(() => map.invalidateSize(), 300);
        } else {
          document.getElementById('map').innerHTML =
            "<p style='color:red;text-align:center'>Map not found for this location.</p>";
        }
      })
      .catch(err => {
        console.error(err);
        document.getElementById('map').innerHTML =
          "<p style='color:red;text-align:center'>Error loading map.</p>";
      });
</script>
</body>
</html>
<!--<!DOCTYPE html>-->
<!--<html lang="en" xmlns:th="http://www.thymeleaf.org">-->
<!--<head th:replace="fragments/header :: head('listings-detail')">-->
<!--    <title th:text="${selectedList.title}">List Detail</title>-->
<!--    <link rel="stylesheet" th:href="@{/css/style.css}">-->
<!--</head>-->
<!--<body>-->
<!--<div th:replace="fragments/header :: navbar"></div>-->

<!--<div class="container mt-3">-->

<!--    &lt;!&ndash; ‚úÖ Success Message &ndash;&gt;-->
<!--    <div th:if="${success}" class="alert alert-success" role="alert">-->
<!--        <i class="fa-solid fa-check-circle"></i> <span th:text="${success}"></span>-->
<!--    </div>-->

<!--    &lt;!&ndash; ‚ùå Failure Message &ndash;&gt;-->
<!--    <div th:if="${failure}" class="alert alert-danger" role="alert">-->
<!--        <i class="fa-solid fa-xmark"></i> <span th:text="${failure}"></span>-->
<!--    </div>-->

<!--    <div th:if="${delete}" class="alert alert-success" role="alert">-->
<!--        <i class="fa-solid fa-check-circle"></i> <span th:text="${delete}"></span>-->
<!--    </div>-->

<!--    &lt;!&ndash; ‚ùå Failure Message &ndash;&gt;-->
<!--    <div th:if="${reviewError}" class="alert alert-danger" role="alert">-->
<!--        <i class="fa-solid fa-xmark"></i> <span th:text="${reviewError}"></span>-->
<!--    </div>-->

<!--    <div th:if="${message}" class="alert alert-success" role="alert">-->
<!--        <i class="fa-solid fa-xmark"></i> <span th:text="${message}"></span>-->
<!--    </div>-->

<!--</div>-->

<!--&lt;!&ndash; üîô Back Button &ndash;&gt;-->
<!--<div class="mt-3 offset-1">-->
<!--    <a th:href="@{/listings/all}">-->
<!--        <button class="btn btn-dark"><i class="fa-solid fa-backward"></i></button>-->
<!--    </a>-->
<!--</div>-->

<!--<main class="container my-4">-->
<!--    <div class="row">-->
<!--        <div class="col-6 listings-card offset-3 show-card">-->
<!--            <div>-->
<!--                <h3 th:text="${selectedList.title}">Listing Title</h3>-->
<!--            </div>-->

<!--            &lt;!&ndash; ‚úÖ Single Image URL instead of images list &ndash;&gt;-->
<!--            <img th:src="${selectedList.images_url}"-->
<!--                 class="img-fluid rounded show-img"-->
<!--                 alt="Listing image"/>-->

<!--            <div class="card-body mt-3">-->
<!--                <h5><strong th:text="${selectedList.title}"></strong></h5>-->
<!--                <p class="card-text">-->
<!--                    <strong>Description:</strong>-->
<!--                    <span th:text="${selectedList.description}"></span><br><br>-->

<!--                    <strong>Location:</strong>-->
<!--                    <span th:text="${selectedList.location}"></span><br><br>-->

<!--                    <strong>Price per Night:</strong>-->
<!--                    ‚Çπ <span th:text="${selectedList.price}"></span> / night<br><br>-->

<!--                    <strong>Country:</strong>-->
<!--                    <span th:text="${selectedList.country}"></span>-->
<!--                </p>-->
<!--            </div>-->
<!--        </div>-->

<!--        &lt;!&ndash; ‚úèÔ∏è Edit Button &ndash;&gt;-->
<!--        <div class="col-1">-->
<!--            <a th:href="@{/listings/{id}/edit(id=${selectedList.id})}">-->
<!--                <button class="btn btn-primary">-->
<!--                    <i class="fa-regular fa-pen-to-square"></i>-->
<!--                </button>-->
<!--            </a>-->
<!--        </div>-->

<!--        &lt;!&ndash; üóëÔ∏è Delete Button &ndash;&gt;-->
<!--        <div class="col-1">-->
<!--            <form th:action="@{/listings/{id}/delete(id=${selectedList.id})}" method="post">-->
<!--                <button type="submit" class="delete-btn">-->
<!--                    <i class="fa-solid fa-trash"></i>-->
<!--                </button>-->
<!--            </form>-->
<!--        </div>-->

<!--        &lt;!&ndash; ‚≠ê Reviews Section &ndash;&gt;-->
<!--        <div class="col-8 offset-3 mb-3 mt-4">-->
<!--            <hr>-->
<!--            <h4>Leave a Review</h4>-->

<!--            <form th:action="@{/reviews/add/{listingId}(listingId=${selectedList.id})}"-->
<!--                  th:object="${newReview}"-->
<!--                  method="post"-->
<!--                  novalidate-->
<!--                  class="needs-validation">-->

<!--                <div class="mb-3 mt-3">-->
<!--                    <label for="reviews" class="form-label">Rating</label>-->
<!--                    <input type="range" min="1" max="5" th:field="*{reviews}" id="review" class="form-range"/>-->
<!--                </div>-->

<!--                <div class="mb-3 mt-3">-->
<!--                    <label for="comment" class="form-label">Comment</label>-->
<!--                    <textarea th:field="*{comment}" cols="30" rows="5" id="comment" class="form-control" required></textarea>-->
<!--                    <div class="invalid-feedback">Please add some comments for review</div>-->
<!--                </div>-->

<!--                <button type="submit" class="btn btn-success">Submit Review</button>-->
<!--            </form>-->

<!--            <hr>-->

<!--            <p><b>All Reviews</b></p>-->

<!--            <div class="row">-->
<!--                &lt;!&ndash; ü™∂ No Reviews Case &ndash;&gt;-->
<!--                <div th:if="${#lists.isEmpty(selectedList.reviews)}" class="col-12">-->
<!--                    <div class="card p-3 shadow-sm">-->
<!--                        <h5 class="card-title">No reviews yet. Be the first to review!</h5>-->
<!--                    </div>-->
<!--                </div>-->

<!--                &lt;!&ndash; üí¨ Each Review &ndash;&gt;-->
<!--                <div th:each="review : ${selectedList.reviews}" class="col-md-6 mb-3">-->
<!--                    <div class="card shadow-sm h-100">-->
<!--                        <div class="card-body mb-3 ms-3 mt-3">-->
<!--                            <h5 class="card-title">Anonymous User</h5>-->
<!--                            <p class="card-text mb-1">-->
<!--                                <strong>Rating:</strong>-->
<!--                                <span th:text="${review.reviews}">5</span> ‚≠ê-->
<!--                            </p>-->
<!--                            <p class="card-text">-->
<!--                                <strong>Comment:</strong>-->
<!--                                <span th:text="${review.comment}">Nice place!</span>-->
<!--                            </p>-->
<!--                            <form th:action="@{/reviews/{listingId}/delete/{reviewId}(listingId=${selectedList.id}, reviewId=${review.id})}"-->
<!--                                  method="post"-->
<!--                                  onsubmit="return confirm('Are you sure you want to delete this review?');">-->
<!--                                <button type="submit" class="btn btn-danger btn-sm">-->
<!--                                    <i class="fa fa-trash"></i> Delete-->
<!--                                </button>-->
<!--                            </form>-->
<!--                        </div>-->
<!--                    </div>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->
<!--</main>-->

<!--<div th:replace="fragments/footer :: footer"></div>-->
<!--<script th:src="@{/js/script.js}"></script>-->
<!--</body>-->
<!--</html>-->
